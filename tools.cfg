[gcode_macro SET_TOOL_COLOR]
gcode:
  {% set rgb_color = params.COLOR | default("") | string %}
  {% if rgb_color != "" %}
    {% set R = (rgb_color[0] + rgb_color[1]) | int(0,16) %}
    {% set G = (rgb_color[2] + rgb_color[3]) | int(0,16) %}
    {% set B = (rgb_color[4] + rgb_color[5]) | int(0,16) %}
    {% set pR = (R/255) + 0.0001 %}
    {% set pG = (G/255) + 0.0001 %}
    {% set pB = (B/255) + 0.0001 %}
    {% set K = 1 - ([pR,pG,pB] | sort)[-1] %}
    {% set C = (1 - pR - K) / (1 - K) %}
    {% set M = (1 - pG - K) / (1 - K) %}
    {% set Y = (1 - pB - K) / (1 - K) %}
    {% set W = (0.2126*pR + 0.7152*pG + 0.0722*pB) - 0.8 %}
    {% if (W < 0.001) %}
      {% set W = 0.001 %}
    {% endif %}
    {% set C = C * 0.75 %}
    {% set M = M * 0.2 %}
    {% set Y = Y * 0.7 %}
    {% set K = K * 1 %}
    {% set W = W * 0.1 %}
    {% set pC = C/(C+M+Y+W) %}
    {% set pM = M/(C+M+Y+W) %}
    {% set pY = Y/(C+M+Y+W) %}
    {% set pW = W/(C+M+Y+W) %}
    SET_GCODE_VARIABLE MACRO={params.MACRO} VARIABLE=c VALUE={pC}
    SET_GCODE_VARIABLE MACRO={params.MACRO} VARIABLE=m VALUE={pM}
    SET_GCODE_VARIABLE MACRO={params.MACRO} VARIABLE=y VALUE={pY}
    SET_GCODE_VARIABLE MACRO={params.MACRO} VARIABLE=k VALUE={pW}
  {% endif %}

[gcode_macro SET_CMYK_MIX]
gcode:
  {% set C = params.C|default(0.25)|float %}
  {% set M = params.M|default(0.25)|float %}
  {% set Y = params.Y|default(0.25)|float %}
  {% set K = params.K|default(0.25)|float %}
  {% set rotC = 7.1988 %}
  {% set rotM = 8.0808 %}
  {% set rotY = 8.2152 %}
  {% set rotK = 7.9632 %}
  SYNC_EXTRUDER_MOTION EXTRUDER=extruder_1 MOTION_QUEUE=extruder
  SYNC_EXTRUDER_MOTION EXTRUDER=extruder_2 MOTION_QUEUE=extruder
  SYNC_EXTRUDER_MOTION EXTRUDER=extruder_3 MOTION_QUEUE=extruder
  SYNC_EXTRUDER_MOTION EXTRUDER=extruder_4 MOTION_QUEUE=extruder
  SET_EXTRUDER_ROTATION_DISTANCE EXTRUDER=extruder_1 DISTANCE={rotC/(M+0.0001)}
  SET_EXTRUDER_ROTATION_DISTANCE EXTRUDER=extruder_2 DISTANCE={rotM/(C+0.0001)}
  SET_EXTRUDER_ROTATION_DISTANCE EXTRUDER=extruder_3 DISTANCE={rotY/(K+0.0001)}
  SET_EXTRUDER_ROTATION_DISTANCE EXTRUDER=extruder_4 DISTANCE={rotK/(Y+0.0001)}

[gcode_macro T0]
gcode:
  SET_CMYK_MIX C=1 M=0 Y=0 K=0
variable_c: 0
variable_m: 0
variable_y: 0
variable_k: 0

[gcode_macro T1]
gcode:
  SET_CMYK_MIX C=0 M=1 Y=0 K=0
variable_c: 0
variable_m: 0
variable_y: 0
variable_k: 0

[gcode_macro T2]
gcode:
  SET_CMYK_MIX C=0 M=0 Y=1 K=0
variable_c: 0
variable_m: 0
variable_y: 0
variable_k: 0

[gcode_macro T3]
gcode:
  SET_CMYK_MIX C=0 M=0 Y=0 K=1
variable_c: 0
variable_m: 0
variable_y: 0
variable_k: 0

[gcode_macro T4]
gcode:
  SET_CMYK_MIX C={c} M={m} Y={y} K={k}
variable_c: 0
variable_m: 0
variable_y: 0
variable_k: 0

[gcode_macro T5]
gcode:
  SET_CMYK_MIX C={c} M={m} Y={y} K={k}
variable_c: 0
variable_m: 0
variable_y: 0
variable_k: 0

[gcode_macro T6]
gcode:
  SET_CMYK_MIX C={c} M={m} Y={y} K={k}
variable_c: 0
variable_m: 0
variable_y: 0
variable_k: 0

[gcode_macro T7]
gcode:
  SET_CMYK_MIX C={c} M={m} Y={y} K={k}
variable_c: 0
variable_m: 0
variable_y: 0
variable_k: 0

[gcode_macro T8]
gcode:
  SET_CMYK_MIX C={c} M={m} Y={y} K={k}
variable_c: 0
variable_m: 0
variable_y: 0
variable_k: 0

[gcode_macro T9]
gcode:
  SET_CMYK_MIX C={c} M={m} Y={y} K={k}
variable_c: 0
variable_m: 0
variable_y: 0
variable_k: 0

[gcode_macro T10]
gcode:
  SET_CMYK_MIX C={c} M={m} Y={y} K={k}
variable_c: 0
variable_m: 0
variable_y: 0
variable_k: 0

[gcode_macro T11]
gcode:
  SET_CMYK_MIX C={c} M={m} Y={y} K={k}
variable_c: 0
variable_m: 0
variable_y: 0
variable_k: 0

[gcode_macro T12]
gcode:
  SET_CMYK_MIX C={c} M={m} Y={y} K={k}
variable_c: 0
variable_m: 0
variable_y: 0
variable_k: 0

[gcode_macro T13]
gcode:
  SET_CMYK_MIX C={c} M={m} Y={y} K={k}
variable_c: 0
variable_m: 0
variable_y: 0
variable_k: 0

[gcode_macro T14]
gcode:
  SET_CMYK_MIX C={c} M={m} Y={y} K={k}
variable_c: 0
variable_m: 0
variable_y: 0
variable_k: 0

[gcode_macro T15]
gcode:
  SET_CMYK_MIX C={c} M={m} Y={y} K={k}
variable_c: 0
variable_m: 0
variable_y: 0
variable_k: 0

[gcode_macro T16]
gcode:
  SET_CMYK_MIX C={c} M={m} Y={y} K={k}
variable_c: 0
variable_m: 0
variable_y: 0
variable_k: 0

[gcode_macro T17]
gcode:
  SET_CMYK_MIX C={c} M={m} Y={y} K={k}
variable_c: 0
variable_m: 0
variable_y: 0
variable_k: 0

[gcode_macro T18]
gcode:
  SET_CMYK_MIX C={c} M={m} Y={y} K={k}
variable_c: 0
variable_m: 0
variable_y: 0
variable_k: 0

[gcode_macro T19]
gcode:
  SET_CMYK_MIX C={c} M={m} Y={y} K={k}
variable_c: 0
variable_m: 0
variable_y: 0
variable_k: 0

[gcode_macro T20]
gcode:
  SET_CMYK_MIX C={c} M={m} Y={y} K={k}
variable_c: 0
variable_m: 0
variable_y: 0
variable_k: 0

[gcode_macro T21]
gcode:
  SET_CMYK_MIX C={c} M={m} Y={y} K={k}
variable_c: 0
variable_m: 0
variable_y: 0
variable_k: 0

[gcode_macro T22]
gcode:
  SET_CMYK_MIX C={c} M={m} Y={y} K={k}
variable_c: 0
variable_m: 0
variable_y: 0
variable_k: 0

[gcode_macro T23]
gcode:
  SET_CMYK_MIX C={c} M={m} Y={y} K={k}
variable_c: 0
variable_m: 0
variable_y: 0
variable_k: 0

[gcode_macro T24]
gcode:
  SET_CMYK_MIX C={c} M={m} Y={y} K={k}
variable_c: 0
variable_m: 0
variable_y: 0
variable_k: 0

[gcode_macro T25]
gcode:
  SET_CMYK_MIX C={c} M={m} Y={y} K={k}
variable_c: 0
variable_m: 0
variable_y: 0
variable_k: 0

[gcode_macro T26]
gcode:
  SET_CMYK_MIX C={c} M={m} Y={y} K={k}
variable_c: 0
variable_m: 0
variable_y: 0
variable_k: 0

[gcode_macro T27]
gcode:
  SET_CMYK_MIX C={c} M={m} Y={y} K={k}
variable_c: 0
variable_m: 0
variable_y: 0
variable_k: 0

[gcode_macro T28]
gcode:
  SET_CMYK_MIX C={c} M={m} Y={y} K={k}
variable_c: 0
variable_m: 0
variable_y: 0
variable_k: 0

[gcode_macro T29]
gcode:
  SET_CMYK_MIX C={c} M={m} Y={y} K={k}
variable_c: 0
variable_m: 0
variable_y: 0
variable_k: 0

[gcode_macro T30]
gcode:
  SET_CMYK_MIX C={c} M={m} Y={y} K={k}
variable_c: 0
variable_m: 0
variable_y: 0
variable_k: 0

[gcode_macro T31]
gcode:
  SET_CMYK_MIX C={c} M={m} Y={y} K={k}
variable_c: 0
variable_m: 0
variable_y: 0
variable_k: 0


[gcode_macro T32]
gcode:
  SET_CMYK_MIX C={c} M={m} Y={y} K={k}
variable_c: 0
variable_m: 0
variable_y: 0
variable_k: 0

[gcode_macro T33]
gcode:
  SET_CMYK_MIX C={c} M={m} Y={y} K={k}
variable_c: 0
variable_m: 0
variable_y: 0
variable_k: 0

[gcode_macro T34]
gcode:
  SET_CMYK_MIX C={c} M={m} Y={y} K={k}
variable_c: 0
variable_m: 0
variable_y: 0
variable_k: 0

[gcode_macro T35]
gcode:
  SET_CMYK_MIX C={c} M={m} Y={y} K={k}
variable_c: 0
variable_m: 0
variable_y: 0
variable_k: 0

[gcode_macro T36]
gcode:
  SET_CMYK_MIX C={c} M={m} Y={y} K={k}
variable_c: 0
variable_m: 0
variable_y: 0
variable_k: 0

[gcode_macro T37]
gcode:
  SET_CMYK_MIX C={c} M={m} Y={y} K={k}
variable_c: 0
variable_m: 0
variable_y: 0
variable_k: 0

[gcode_macro T38]
gcode:
  SET_CMYK_MIX C={c} M={m} Y={y} K={k}
variable_c: 0
variable_m: 0
variable_y: 0
variable_k: 0

[gcode_macro T39]
gcode:
  SET_CMYK_MIX C={c} M={m} Y={y} K={k}
variable_c: 0
variable_m: 0
variable_y: 0
variable_k: 0

[gcode_macro T40]
gcode:
  SET_CMYK_MIX C={c} M={m} Y={y} K={k}
variable_c: 0
variable_m: 0
variable_y: 0
variable_k: 0

[gcode_macro T41]
gcode:
  SET_CMYK_MIX C={c} M={m} Y={y} K={k}
variable_c: 0
variable_m: 0
variable_y: 0
variable_k: 0

[gcode_macro T42]
gcode:
  SET_CMYK_MIX C={c} M={m} Y={y} K={k}
variable_c: 0
variable_m: 0
variable_y: 0
variable_k: 0

[gcode_macro T43]
gcode:
  SET_CMYK_MIX C={c} M={m} Y={y} K={k}
variable_c: 0
variable_m: 0
variable_y: 0
variable_k: 0

[gcode_macro T44]
gcode:
  SET_CMYK_MIX C={c} M={m} Y={y} K={k}
variable_c: 0
variable_m: 0
variable_y: 0
variable_k: 0

[gcode_macro T45]
gcode:
  SET_CMYK_MIX C={c} M={m} Y={y} K={k}
variable_c: 0
variable_m: 0
variable_y: 0
variable_k: 0

[gcode_macro T46]
gcode:
  SET_CMYK_MIX C={c} M={m} Y={y} K={k}
variable_c: 0
variable_m: 0
variable_y: 0
variable_k: 0

[gcode_macro T47]
gcode:
  SET_CMYK_MIX C={c} M={m} Y={y} K={k}
variable_c: 0
variable_m: 0
variable_y: 0
variable_k: 0

[gcode_macro T48]
gcode:
  SET_CMYK_MIX C={c} M={m} Y={y} K={k}
variable_c: 0
variable_m: 0
variable_y: 0
variable_k: 0

[gcode_macro T49]
gcode:
  SET_CMYK_MIX C={c} M={m} Y={y} K={k}
variable_c: 0
variable_m: 0
variable_y: 0
variable_k: 0

[gcode_macro T50]
gcode:
  SET_CMYK_MIX C={c} M={m} Y={y} K={k}
variable_c: 0
variable_m: 0
variable_y: 0
variable_k: 0

[gcode_macro T51]
gcode:
  SET_CMYK_MIX C={c} M={m} Y={y} K={k}
variable_c: 0
variable_m: 0
variable_y: 0
variable_k: 0

[gcode_macro T52]
gcode:
  SET_CMYK_MIX C={c} M={m} Y={y} K={k}
variable_c: 0
variable_m: 0
variable_y: 0
variable_k: 0

[gcode_macro T53]
gcode:
  SET_CMYK_MIX C={c} M={m} Y={y} K={k}
variable_c: 0
variable_m: 0
variable_y: 0
variable_k: 0

[gcode_macro T54]
gcode:
  SET_CMYK_MIX C={c} M={m} Y={y} K={k}
variable_c: 0
variable_m: 0
variable_y: 0
variable_k: 0

[gcode_macro T55]
gcode:
  SET_CMYK_MIX C={c} M={m} Y={y} K={k}
variable_c: 0
variable_m: 0
variable_y: 0
variable_k: 0

[gcode_macro T56]
gcode:
  SET_CMYK_MIX C={c} M={m} Y={y} K={k}
variable_c: 0
variable_m: 0
variable_y: 0
variable_k: 0

[gcode_macro T57]
gcode:
  SET_CMYK_MIX C={c} M={m} Y={y} K={k}
variable_c: 0
variable_m: 0
variable_y: 0
variable_k: 0

[gcode_macro T58]
gcode:
  SET_CMYK_MIX C={c} M={m} Y={y} K={k}
variable_c: 0
variable_m: 0
variable_y: 0
variable_k: 0

[gcode_macro T59]
gcode:
  SET_CMYK_MIX C={c} M={m} Y={y} K={k}
variable_c: 0
variable_m: 0
variable_y: 0
variable_k: 0

[gcode_macro T60]
gcode:
  SET_CMYK_MIX C={c} M={m} Y={y} K={k}
variable_c: 0
variable_m: 0
variable_y: 0
variable_k: 0

[gcode_macro T61]
gcode:
  SET_CMYK_MIX C={c} M={m} Y={y} K={k}
variable_c: 0
variable_m: 0
variable_y: 0
variable_k: 0

[gcode_macro T62]
gcode:
  SET_CMYK_MIX C={c} M={m} Y={y} K={k}
variable_c: 0
variable_m: 0
variable_y: 0
variable_k: 0

[gcode_macro T63]
gcode:
  SET_CMYK_MIX C={c} M={m} Y={y} K={k}
variable_c: 0
variable_m: 0
variable_y: 0
variable_k: 0

[gcode_macro DUMP_VARIABLES]
gcode:
    {% set filter_name = params.NAME|default('')|string|lower %}
    {% set filter_value = params.VALUE|default('')|string|lower %}
    {% set show_cfg = params.SHOW_CFG|default(0)|int %}
    
    {% set out = [] %}

    {% for key1 in printer %}
        {% for key2 in printer[key1] %}
            {% if (show_cfg or not (key1|lower == 'configfile' and key2|lower in ['config', 'settings'])) and (filter_name in key1|lower or filter_name in key2|lower) and filter_value in printer[key1][key2]|string|lower %}
                {% set dummy = out.append("printer['%s'].%s = %s" % (key1, key2, printer[key1][key2])) %}
            {% endif %}
        {% else %}
            {% if filter_name in key1|lower and filter_value in printer[key1]|string|lower %}
                {% set dummy = out.append("printer['%s'] = %s" % (key1, printer[key1])) %}
            {% endif %}
        {% endfor %}
    {% endfor %}
    
    {action_respond_info(out|join("\n"))}